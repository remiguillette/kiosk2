<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>BeaverAlarm ‚Äì Simulateur complet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #060608;
      --panel: #0f1018;
      --panel-glow: rgba(248,148,34,0.12);
      --border: rgba(255,255,255,0.08);
      --text-main: #fff;
      --text-muted: rgba(255,255,255,0.68);
      --text-soft: rgba(255,255,255,0.42);
      --accent: #f89422;
      --accent-strong: #ff9f33;
      --success: #47d17b;
      --danger: #ff7b7b;
      --warning: #ffd166;
      --shadow: 0 28px 40px rgba(0,0,0,0.45);
      --font: "Inter", "Segoe UI", system-ui, sans-serif;
    }

    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin:0; height:100%; }
    body {
      min-height: 100vh;
      display:flex; justify-content:center;
      font-family: var(--font);
      background:
        radial-gradient(circle at 15% 20%, rgba(248,148,34,0.12), transparent 55%),
        radial-gradient(circle at 85% 10%, rgba(248,148,34,0.08), transparent 50%),
        var(--bg);
      color: var(--text-main);
      padding: clamp(1.5rem, 3vw, 2rem);
    }

    main { width:min(1220px, 100%); display:grid; gap:1.6rem; }

    header { display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap; }
    .brand { display:flex; gap:.75rem; align-items:center; font-weight:800; letter-spacing:.02em; }
    .brand-badge { width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background:rgba(248,148,34,.15); border:1px solid rgba(248,148,34,.35); }

    .toolbar { display:flex; gap:.6rem; flex-wrap:wrap; }
    .chip { padding:.4rem .7rem; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--border); font-weight:600; font-size:.95rem; }

    .panel { background:var(--panel); border:1px solid var(--border); border-radius:26px; padding:1.4rem; box-shadow:var(--shadow); position:relative; overflow:hidden; isolation:isolate; }
    .panel::after{ content:""; position:absolute; inset:0; background:var(--panel-glow); opacity:0; transition:opacity .18s ease; pointer-events:none; z-index:-1; }
    .panel:hover::after{ opacity:1; }

    .grid { display:grid; gap:1.2rem; grid-template-columns: 1.2fr 1fr .9fr; }
    @media (max-width:1100px){ .grid{ grid-template-columns: 1fr 1fr; } }
    @media (max-width:780px){ .grid{ grid-template-columns: 1fr; } }

    .section-title { margin:0 0 .8rem; font-size:1.2rem; font-weight:700; }
    .panel-heading{ display:flex; align-items:center; justify-content:space-between; gap:.8rem; flex-wrap:wrap; margin-bottom:.6rem; }
    .panel-heading .section-title{ margin:0; }
    .system-inline{ display:flex; align-items:center; gap:.5rem; }
    .system-inline .system-label{ font-size:.95rem; color:var(--text-muted); font-weight:600; letter-spacing:.02em; }

    .status-chip { composes: chip; }
    .status-chip { display:inline-flex; align-items:center; gap:.45rem; }
    .status-chip--disarmed { background: rgba(71,209,123,.16); color:var(--success); border-color: rgba(71,209,123,.38); }
    .status-chip--exit { background: rgba(248,148,34,.18); color:var(--accent-strong); border-color: rgba(248,148,34,.4); }
    .status-chip--stay { background: rgba(248,148,34,.18); color:var(--accent-strong); border-color: rgba(248,148,34,.4); }
    .status-chip--away { background: rgba(248,148,34,.18); color:var(--accent-strong); border-color: rgba(248,148,34,.4); }
    .status-chip--entry { background: rgba(248,148,34,.18); color:var(--warning); border-color: rgba(255,209,102,.45); }
    .status-chip--alarm { background: rgba(255,107,107,.18); color:var(--danger); border-color: rgba(255,107,107,.55); }

    .msg { color:var(--text-muted); min-height:1.5rem; margin-bottom:.8rem; }
    .msg--ok{ color:var(--success); }
    .msg--warn{ color:var(--accent-strong); }
    .msg--err{ color:var(--danger); }

    /* Keypad */
    .code { font-size:2rem; letter-spacing:.4rem; font-weight:700; text-align:center; padding:.6rem .9rem; border-radius:18px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); }
    .keygrid { display:grid; grid-template-columns: repeat(3, minmax(56px, 1fr)); gap:.6rem; margin-top:.6rem; }
    .key, .action { appearance:none; border:none; border-radius:16px; font-weight:700; font-size:1.05rem; padding:.85rem; cursor:pointer; color:var(--text-main); background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); transition: transform .16s, background .16s, border .16s, box-shadow .16s; }
    .key:hover, .key:focus-visible, .action:hover, .action:focus-visible{ transform: translateY(-2px); border-color:var(--accent); background:rgba(248,148,34,.16); outline:none; box-shadow:0 10px 24px rgba(248,148,34,.18); }
    .action-row{ display:flex; gap:.6rem; margin-top:.6rem; flex-wrap:wrap; }
    .action--stay{ background: rgba(248,148,34,.16); border-color: rgba(248,148,34,.4); }
    .action--away{ background: rgba(255,107,107,.16); border-color: rgba(255,107,107,.38); }
    .action--disarm{ background: rgba(71,209,123,.16); border-color: rgba(71,209,123,.38); color:var(--success); }

    /* Zones */
    .zone-list{ display:grid; gap:.6rem; }
    .zone{ display:grid; grid-template-columns: 1fr auto; gap:.6rem; align-items:center; padding:.8rem 1rem; border-radius:16px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); }
    .zone:hover{ border-color:var(--accent); background:rgba(248,148,34,.12); }
    .z-left{ display:flex; align-items:center; gap:.65rem; font-weight:700; }
    .dot{ width:12px; height:12px; border-radius:999px; background:rgba(71,209,123,.65); box-shadow:0 0 0 4px rgba(71,209,123,.14); }
    .dot.open{ background:rgba(255,107,107,.9); box-shadow:0 0 0 4px rgba(255,107,107,.2); }
    .z-badges{ display:flex; gap:.4rem; }
    .badge{ font-size:.75rem; letter-spacing:.02em; padding:.15rem .45rem; border-radius:999px; border:1px solid rgba(255,255,255,.14); color:var(--text-soft); }
    .badge--type{ }
    .badge--bypass{ color:var(--warning); border-color: rgba(255,209,102,.4); background: rgba(255,209,102,.12); }
    .badge--fault{ color:var(--danger); border-color: rgba(255,107,107,.45); background: rgba(255,107,107,.12); }

    .zone-controls{ display:flex; gap:.5rem; align-items:center; }
    .zone-controls input[type="checkbox"]{ transform: translateY(1px); }
    .zone-state{ font-size:.9rem; color:var(--text-muted); }

    /* Log */
    .log{ list-style:none; margin:0; padding:0; display:grid; gap:.5rem; }
    .log li{ display:flex; justify-content:space-between; gap:.8rem; padding:.6rem .8rem; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); font-size:.95rem; }
    .log-time{ color:var(--text-soft); font-feature-settings:"tnum" 1, "lnum" 1; min-width:64px; }
    .log-msg{ flex:1; text-align:right; color:var(--text-muted); }

    /* Sim controls */
    .sim-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:.6rem; }
    @media (max-width:780px){ .sim-grid{ grid-template-columns: 1fr; } }
    .select, .input { width:100%; padding:.6rem .8rem; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:var(--text-main); }
    .row{ display:flex; gap:.6rem; align-items:center; }

    .muted{ color:var(--text-soft); font-size:.92rem; }
  </style>
</head>
<body>
  <main>
    <header>
      <div class="brand">
        <span class="brand-badge">ü¶´</span>
        <div>
          <div>BeaverAlarm</div>
          <div class="muted">Simulateur complet (sans serveur)</div>
        </div>
      </div>
    </header>

    <section class="grid">
      <!-- Keypad / actions -->
      <article class="panel">
        <div class="panel-heading">
          <h3 class="section-title">Clavier</h3>
          <div class="system-inline">
            <span class="system-label">√âtat du syst√®me</span>
            <span id="stateChip" class="chip status-chip status-chip--disarmed">D√©sarm√©e</span>
          </div>
        </div>
        <div id="statusMsg" class="msg">Syst√®me pr√™t √† √™tre arm√©.</div>
        <div id="codeDisplay" class="code">----</div>
        <div class="keygrid" id="digits"></div>
        <div class="action-row">
          <button class="action action--stay" id="btnStay">Armement pr√©sence</button>
          <button class="action action--away" id="btnAway">Armement absence</button>
          <button class="action action--disarm" id="btnDisarm">D√©sarmer</button>
          <button class="action" id="btnClear">Effacer</button>
        </div>
        <div class="action-row">
          <button class="action" id="btnPanic">PANIC üö®</button>
          <button class="action" id="btnFire">FEU üî• (24h)</button>
          <button class="action" id="btnMedical">M√©dical ‚õëÔ∏è (24h)</button>
        </div>
      </article>

      <!-- Zones -->
      <article class="panel">
        <h3 class="section-title">Zones surveill√©es</h3>
        <div class="zone-list" id="zoneList"></div>
      </article>

    </section>
  </main>

  <script>
  (() => {
    // =====================
    // Configuration & mod√®le
    // =====================
    const CONFIG = {
      entryDelay: 30,      // s
      exitDelay: 45,       // s
      alarmDuration: 120,  // s (auto-silence)
      codes: [
        { label: 'Ma√Ætre', code: '1234', level: 'master' },
        { label: 'Utilisateur', code: '4321', level: 'user' },
      ],
      zones: [
        // type: 'perimeter' (retard entr√©e), 'interior' (suivi), 'instant', '24h'
        { id: 'frontDoor',  labelFR: 'Porte principale', type: 'perimeter' },
        { id: 'garage',     labelFR: 'Garage',           type: 'perimeter' },
        { id: 'livingRoom', labelFR: 'Salon (mouvement)',type: 'interior' },
        { id: 'basement',   labelFR: 'Sous-sol',         type: 'instant' },
        { id: 'smoke',      labelFR: 'Fum√©e (24h)',      type: '24h' },
      ],
    };

    const STATE = {
      DISARMED: 'DISARMED',
      EXIT_DELAY: 'EXIT_DELAY',
      ARMED_STAY: 'ARMED_STAY',
      ARMED_AWAY: 'ARMED_AWAY',
      ENTRY_DELAY: 'ENTRY_DELAY',
      ALARM: 'ALARM',
    };

    // =====================
    // Persistant simple (localStorage)
    // =====================
    const store = {
      get k(){ return 'beaveralarm.sim.v1'; },
      load(){ try{ return JSON.parse(localStorage.getItem(this.k))||{} }catch{ return {} } },
      save(v){ try{ localStorage.setItem(this.k, JSON.stringify(v)); }catch{} },
    };

    const persisted = store.load();

    // =====================
    // Runtime
    // =====================
    const runtime = {
      lang: 'fr',
      system: STATE.DISARMED,
      input: '',
      zones: CONFIG.zones.map(z => ({...z, open:false, bypass:false, fault:false})),
      timers: { entry:0, exit:0, alarm:0 },
      powerOK: true,
      netOK: true,
      timeScale: Number(persisted.timeScale||1),
      log: persisted.log || [],
      scenario: null,
      siren: { active:false, node:null, ctx:null, stop:()=>{} },
    };

    // Restore open/bypass from persistence if any
    if (persisted.zones){
      runtime.zones.forEach(z => {
        const p = persisted.zones[z.id];
        if (p){ z.open=!!p.open; z.bypass=!!p.bypass; z.fault=!!p.fault; }
      });
    }

    // =====================
    // DOM refs
    // =====================
    const el = {
      stateChip: document.getElementById('stateChip'),
      statusMsg: document.getElementById('statusMsg'),
      codeDisplay: document.getElementById('codeDisplay'),
      digits: document.getElementById('digits'),
      btnStay: document.getElementById('btnStay'),
      btnAway: document.getElementById('btnAway'),
      btnDisarm: document.getElementById('btnDisarm'),
      btnClear: document.getElementById('btnClear'),
      btnPanic: document.getElementById('btnPanic'),
      btnFire: document.getElementById('btnFire'),
      btnMedical: document.getElementById('btnMedical'),
      zoneList: document.getElementById('zoneList'),
      log: document.getElementById('log'),
      emptyLog: document.getElementById('emptyLog'),
      scenario: document.getElementById('scenario'),
      runScenario: document.getElementById('btnRunScenario'),
      stopScenario: document.getElementById('btnStopScenario'),
      timeScale: document.getElementById('timeScale'),
      countdown: document.getElementById('countdown'),
    };

    // =====================
    // Utils
    // =====================
    const t = (s)=> ({
      DISARMED:'D√©sarm√©e', EXIT_DELAY:'Sortie', ARMED_STAY:'Arm√©e (pr√©sence)', ARMED_AWAY:'Arm√©e (absence)', ENTRY_DELAY:'Entr√©e', ALARM:'ALERTE',
    }[s]||s);

    const nowStr = () => {
      const d = new Date();
      return d.toLocaleTimeString('fr-CA', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
    }

    function log(msg){
      runtime.log.unshift({ ts: Date.now(), msg });
      if (runtime.log.length > 50) runtime.log.length = 50;
      renderLog();
      persist();
    }

    function persist(){
      store.save({
        timeScale: runtime.timeScale,
        zones: Object.fromEntries(runtime.zones.map(z=>[z.id,{open:z.open, bypass:z.bypass, fault:z.fault}]) ),
        log: runtime.log,
      });
    }

    function setMsg(message, cls){
      el.statusMsg.textContent = message;
      el.statusMsg.classList.remove('msg--ok','msg--warn','msg--err');
      if (cls) el.statusMsg.classList.add(cls);
    }

    function setChip(state){
      el.stateChip.textContent = t(state);
      el.stateChip.className = 'chip status-chip ' + (
        state===STATE.DISARMED ? 'status-chip--disarmed' :
        state===STATE.EXIT_DELAY ? 'status-chip--exit' :
        state===STATE.ARMED_STAY ? 'status-chip--stay' :
        state===STATE.ARMED_AWAY ? 'status-chip--away' :
        state===STATE.ENTRY_DELAY ? 'status-chip--entry' :
        'status-chip--alarm'
      );
    }

    function displayCode(){ el.codeDisplay.textContent = runtime.input ? '‚Ä¢'.repeat(runtime.input.length) : '----'; }

    function checkCode(){
      return CONFIG.codes.find(c => c.code === runtime.input);
    }

    function clearCode(){ runtime.input=''; displayCode(); }

    function anyOpenPerimeter(){ return runtime.zones.some(z => z.type==='perimeter' && z.open && !z.bypass); }
    function anyOpenNonBypassed(){ return runtime.zones.some(z => z.open && !z.bypass); }

    function setSystem(state){
      runtime.system = state;
      setChip(state);
      persist();
    }

    function arm(mode){
      const code = checkCode();
      if (!code || runtime.input.length<4){ setMsg('Entrez un code valide.', 'msg--warn'); return; }
      if (anyOpenNonBypassed()){
        setMsg('Armement impossible: zones ouvertes.', 'msg--err');
        log(`Blocage armement (zones ouvertes).`);
        return;
      }
      runtime.timers.exit = CONFIG.exitDelay;
      setSystem(STATE.EXIT_DELAY);
      setMsg(`Sortie: ${CONFIG.exitDelay}s`, 'msg--warn');
      log(`Armement initialis√© (${mode===STATE.ARMED_STAY?'pr√©sence':'absence'}) ‚Äì d√©lai sortie ${CONFIG.exitDelay}s.`);
      runtime.pendingArm = mode; // remember target
      clearCode();
    }

    function disarm({force=false}={}){
      const code = checkCode();
      if (!force && (!code || runtime.input.length<4)){
        setMsg('Code invalide.', 'msg--err');
        return;
      }
      const was = runtime.system;
      setSystem(STATE.DISARMED);
      runtime.timers = { entry:0, exit:0, alarm:0 };
      siren(false);
      setMsg('Syst√®me d√©sarm√©.', 'msg--ok');
      log(`D√©sarment (${code?code.label:'forc√©'}) depuis ${t(was)}.`);
      clearCode();
    }

    function zoneById(id){ return runtime.zones.find(z=>z.id===id); }

    function openZone(id, open=true){
      const z = zoneById(id); if (!z) return;
      if (z.open === open) return;
      z.open = open; persist(); renderZones();

      const label = z.labelFR;
      log(`${open?'Ouverture':'Fermeture'} zone: ${label}`);

      // 24h zones trigger immediate alarm
      if (z.type==='24h') return alarm('Alarme 24h: ' + label);

      switch (runtime.system){
        case STATE.DISARMED:
          setMsg(open?`Zone ouverte: ${label}`:`Zone referm√©e: ${label}`);
          break;
        case STATE.ARMED_STAY:
        case STATE.ARMED_AWAY:
        case STATE.EXIT_DELAY:
          if (open){
            if (z.type==='perimeter') startEntryDelay(label);
            else if (z.type==='instant') alarm(`Zone instantan√©e: ${label}`);
            else if (z.type==='interior' && runtime.system===STATE.ARMED_AWAY) alarm(`Mouvement int√©rieur: ${label}`);
          }
          break;
        case STATE.ENTRY_DELAY:
          // keep counting; opening more zones has no effect
          break;
      }
    }

    function startEntryDelay(label){
      runtime.timers.entry = CONFIG.entryDelay;
      setSystem(STATE.ENTRY_DELAY);
      setMsg(`Entr√©e: ${CONFIG.entryDelay}s (zone ${label})`, 'msg--warn');
      log(`D√©lai d'entr√©e d√©clench√© (${label}) ${CONFIG.entryDelay}s.`);
    }

    function alarm(reason){
      setSystem(STATE.ALARM);
      runtime.timers.alarm = CONFIG.alarmDuration;
      setMsg(`ALERTE: ${reason}`, 'msg--err');
      log(`ALERTE üö® ${reason} (auto-silence ${CONFIG.alarmDuration}s)`);
      siren(true);
    }

    // Simple synth siren (WebAudio), no external asset
    function siren(on){
      try{
        if (on && !runtime.siren.active){
          const ctx = new (window.AudioContext||window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type='sawtooth'; o.frequency.value=600; g.gain.value=0.001; // low volume
          o.connect(g).connect(ctx.destination);
          o.start();
          let up=true; let f=600;
          const mod = setInterval(()=>{ f += (up?30:-30); if (f>1200||f<500) up=!up; o.frequency.value=f; }, 60);
          runtime.siren = { active:true, ctx, node:o, stop:()=>{ clearInterval(mod); o.stop(); ctx.close(); } };
        }
        if (!on && runtime.siren.active){ runtime.siren.stop(); runtime.siren={active:false,node:null,ctx:null,stop:()=>{}}; }
      }catch(e){ /* ignore audio errors (permissions) */ }
    }

    // =====================
    // Ticker
    // =====================
    let tickHandle = null;
    function startTicker(){ if (tickHandle) return; tickHandle = setInterval(tick, 250); }
    function stopTicker(){ clearInterval(tickHandle); tickHandle=null; }
    function tick(){
      const scale = runtime.timeScale || 1;
      const dt = 0.25 * scale; // seconds advanced per tick
      // countdowns
      if (runtime.system===STATE.EXIT_DELAY){
        runtime.timers.exit = Math.max(0, runtime.timers.exit - dt);
        el.countdown.textContent = `Sortie: ${Math.ceil(runtime.timers.exit)}s`;
        if (runtime.timers.exit===0){
          const target = runtime.pendingArm||STATE.ARMED_AWAY;
          setSystem(target);
          setMsg(target===STATE.ARMED_STAY? 'Surveillance p√©rim√©trique active.' : 'Toutes les zones sont surveill√©es.', 'msg--ok');
          log(`Syst√®me arm√© (${target===STATE.ARMED_STAY?'pr√©sence':'absence'}).`);
          el.countdown.textContent = '';
        }
      }
      if (runtime.system===STATE.ENTRY_DELAY){
        runtime.timers.entry = Math.max(0, runtime.timers.entry - dt);
        el.countdown.textContent = `Entr√©e: ${Math.ceil(runtime.timers.entry)}s`;
        if (runtime.timers.entry===0){ el.countdown.textContent=''; alarm('D√©lai d\'entr√©e expir√©'); }
      }
      if (runtime.system===STATE.ALARM){
        runtime.timers.alarm = Math.max(0, runtime.timers.alarm - dt);
        el.countdown.textContent = `Sir√®ne: ${Math.ceil(runtime.timers.alarm)}s`;
        if (runtime.timers.alarm===0){ siren(false); el.countdown.textContent=''; setMsg('Alarme auto-silenc√©e. M√©moire active.', 'msg--warn'); }
      }
    }

    // =====================
    // Sc√©narios
    // =====================
    let scenarioTimer = null;
    function runScenario(name){
      stopScenario();
      if (!name || name==='none') return;
      const s = scenarios[name];
      if (!s) return;
      s();
    }

    function stopScenario(){ if (scenarioTimer){ clearTimeout(scenarioTimer); scenarioTimer=null; } runtime.scenario=null; }
    function after(ms, fn){ scenarioTimer = setTimeout(fn, ms/ (runtime.timeScale||1)); }

    const scenarios = {
      night(){
        // Stay arm, then open door ‚Üí entry delay ‚Üí disarm
        runtime.input='1234'; displayCode(); arm(STATE.ARMED_STAY);
        after(1000, ()=>{ // during exit, keep still
          after((CONFIG.exitDelay+2)*1000, ()=>{
            openZone('frontDoor', true);
            after(2000, ()=>{ runtime.input='1234'; displayCode(); disarm(); openZone('frontDoor', false); });
          });
        });
      },
      away(){
        runtime.input='1234'; displayCode(); arm(STATE.ARMED_AWAY);
        after((CONFIG.exitDelay+2)*1000, ()=>{
          openZone('livingRoom', true); // interior causes instant alarm in away
          after(4000, ()=>{ runtime.input='1234'; displayCode(); disarm(); openZone('livingRoom', false); });
        });
      },
      forgetDoor(){
        openZone('frontDoor', true);
        runtime.input='1234'; displayCode(); arm(STATE.ARMED_AWAY); // should block
        after(2500, ()=> openZone('frontDoor', false));
      },
      powerDown(){
        setPower(false); after(10000, ()=> setPower(true));
      },
      netFail(){
        setNet(false); after(15000, ()=> setNet(true));
      },
      smoke24h(){
        openZone('smoke', true); after(5000, ()=> openZone('smoke', false));
      },
    };

    // =====================
    // Power / Net indicators
    // =====================
    function setPower(ok){
      runtime.powerOK = ok;
      if (!ok) {
        setMsg('Panne secteur d√©tect√©e.', 'msg--warn');
        log('Panne secteur');
      } else {
        log('Secteur r√©tabli');
      }
    }
    function setNet(ok){
      runtime.netOK = ok;
      if (!ok) {
        setMsg('R√©seau perdu.', 'msg--warn');
        log('Perte r√©seau');
      } else {
        log('R√©seau r√©tabli');
      }
    }

    // =====================
    // Renderers
    // =====================
    function renderDigits(){
      const frag = document.createDocumentFragment();
      for (let i=1;i<=9;i++) frag.appendChild(makeDigit(i));
      frag.appendChild(makeDigit(0));
      el.digits.appendChild(frag);
      function makeDigit(n){ const b=document.createElement('button'); b.className='key'; b.textContent=String(n); b.addEventListener('click',()=>{ if (runtime.input.length<6){ runtime.input+=String(n); displayCode(); } }); return b; }
    }

    function renderZones(){
      el.zoneList.innerHTML='';
      runtime.zones.forEach(z=>{
        const row=document.createElement('div'); row.className='zone';
        const left=document.createElement('div'); left.className='z-left';
        const dot=document.createElement('span'); dot.className='dot'+(z.open?' open':'');
        const name=document.createElement('span'); name.textContent=z.labelFR;
        const badges=document.createElement('div'); badges.className='z-badges';
        const type=document.createElement('span'); type.className='badge badge--type'; type.textContent=typeLabel(z.type);
        badges.appendChild(type);
        if (z.bypass){ const b=document.createElement('span'); b.className='badge badge--bypass'; b.textContent='Bypass'; badges.appendChild(b); }
        if (z.fault){ const b=document.createElement('span'); b.className='badge badge--fault'; b.textContent='D√©faut'; badges.appendChild(b); }
        left.append(dot,name,badges);

        const right=document.createElement('div'); right.className='zone-controls';
        const state=document.createElement('span'); state.className='zone-state'; state.textContent = z.open?'Ouverte':'S√©curis√©e';
        const toggle=document.createElement('button'); toggle.className='action'; toggle.textContent = z.open?'Fermer':'Ouvrir'; toggle.addEventListener('click',()=> openZone(z.id, !z.open));
        const chk=document.createElement('label'); chk.className='row'; chk.style.gap='.35rem';
        const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=z.bypass; cb.addEventListener('change',()=>{ z.bypass=cb.checked; persist(); renderZones(); log(`Zone ${z.labelFR} ${z.bypass?'bypass√©e':'active'}`); });
        const cbl=document.createElement('span'); cbl.className='muted'; cbl.textContent='Bypass';
        chk.append(cb,cbl);
        right.append(state, toggle, chk);

        row.append(left,right);
        el.zoneList.appendChild(row);
      });

      function typeLabel(t){ return ({ perimeter:'P√©rim√®tre', interior:'Int√©rieur', instant:'Instant', '24h':'24h' })[t] || t; }
    }

    function renderLog(){
      el.log.innerHTML='';
      if (!runtime.log.length){ el.emptyLog.hidden=false; return; }
      el.emptyLog.hidden=true;
      runtime.log.forEach(e=>{
        const li=document.createElement('li');
        const ts=document.createElement('span'); ts.className='log-time'; ts.textContent=new Date(e.ts).toLocaleTimeString('fr-CA',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        const msg=document.createElement('span'); msg.className='log-msg'; msg.textContent=e.msg;
        li.append(ts,msg); el.log.appendChild(li);
      });
    }

    // =====================
    // Event wiring
    // =====================
    renderDigits();
    renderZones();
    renderLog();
    setChip(runtime.system);
    displayCode();
    el.timeScale.value = runtime.timeScale;

    el.btnStay.addEventListener('click', ()=> arm(STATE.ARMED_STAY));
    el.btnAway.addEventListener('click', ()=> arm(STATE.ARMED_AWAY));
    el.btnDisarm.addEventListener('click', ()=> disarm());
    el.btnClear.addEventListener('click', ()=> { clearCode(); setMsg(''); });

    el.btnPanic.addEventListener('click', ()=> alarm('PANIC'));
    el.btnFire.addEventListener('click', ()=> openZone('smoke', true));
    el.btnMedical.addEventListener('click', ()=> alarm('M√©dical'));

    el.timeScale.addEventListener('change', ()=>{ runtime.timeScale=Math.max(0.1, Number(el.timeScale.value)||1); persist(); });

    el.runScenario.addEventListener('click', ()=> runScenario(el.scenario.value));
    el.stopScenario.addEventListener('click', ()=> stopScenario());

    startTicker();

    // Expose helpers for console testing
    window.__sim = { openZone, arm, disarm:()=>disarm({force:true}), setPower, setNet, state:()=>runtime };
  })();
  </script>
</body>
</html>
