<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>BeaverPhone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
      --bg: #060608;
      --panel: #0f1018;
      --panel-glow: rgba(248, 148, 34, 0.12);
      --border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.64);
      --text-soft: rgba(255, 255, 255, 0.42);
      --accent: #f89422;
      --accent-strong: #ff9f33;
      --font: "Inter", "Segoe UI", sans-serif;
      --shadow: 0 28px 40px rgba(0, 0, 0, 0.45);
    }

    html {
      font-size: clamp(13px, 0.95vw, 16px);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: var(--font);
      background: radial-gradient(circle at 15% 20%, rgba(248, 148, 34, 0.12), transparent 55%),
        radial-gradient(circle at 85% 10%, rgba(248, 148, 34, 0.08), transparent 50%),
        var(--bg);
      color: var(--text-main);
      padding: clamp(2.5rem, 5vw + 1rem, 3.5rem) clamp(1.25rem, 4vw, 2.5rem);
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    body::-webkit-scrollbar {
      display: none;
    }

    .beaverphone {
      width: min(1040px, 100%);
      display: grid;
      gap: 2.6rem;
    }

    header {
      display: flex;
      align-items: center;
      gap: 1rem;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .header-title {
      display: inline-flex;
      align-items: center;
      gap: 0.85rem;
      flex: 1 1 auto;
      min-width: min(260px, 100%);
      justify-content: flex-start;
    }

    header .eyebrow {
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-size: clamp(1.6rem, 4vw, 2.3rem);
      font-weight: 700;
      color: var(--accent);
    }

    .menu-return {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
      transition: color 160ms ease, border 160ms ease, background 160ms ease, transform 160ms ease;
    }

    .menu-return:hover,
    .menu-return:focus-visible {
      color: var(--accent);
      border-color: var(--accent);
      background: rgba(248, 148, 34, 0.14);
      transform: translateY(-2px);
      outline: none;
    }

    .menu-return svg {
      width: 24px;
      height: 24px;
      stroke-width: 1.8;
    }

    .lang-toggle {
      display: inline-flex;
      gap: 0.5rem;
      background: rgba(24, 24, 32, 0.6);
      padding: 0.4rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.95rem;
      padding: 0.4rem 0.9rem;
      border-radius: 999px;
      cursor: pointer;
      transition: color 150ms ease, background 150ms ease, transform 150ms ease;
    }

    .lang-btn:hover {
      color: var(--text-main);
      transform: translateY(-1px);
    }

    .lang-btn.active {
      background: var(--accent);
      color: #121219;
      box-shadow: 0 8px 18px rgba(248, 148, 34, 0.35);
    }

    .app {
      display: grid;
      gap: 2.4rem;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 26px;
      padding: 1.95rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .panel::after {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--panel-glow);
      opacity: 0;
      transition: opacity 180ms ease;
      pointer-events: none;
      z-index: -1;
    }

    .panel:focus-within::after,
    .panel:hover::after {
      opacity: 1;
    }

    .dialpad-header {
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.8rem;
    }

    .status-cluster {
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .dialpad-header h2 {
      font-size: 1.35rem;
      font-weight: 600;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.02);
      transition: border 160ms ease, color 160ms ease;
    }

    .status-pill .status-text {
      line-height: 1;
    }

    .ws-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.35rem 0.75rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      font-size: 0.78rem;
      color: var(--text-muted);
      background: rgba(255, 255, 255, 0.02);
      transition: border 160ms ease, color 160ms ease, background 160ms ease;
    }

    .ws-indicator .ws-icon {
      display: inline-flex;
      width: 18px;
      height: 18px;
    }

    .ws-indicator .ws-icon svg {
      width: 100%;
      height: 100%;
    }

    @keyframes wsPulse {
      0% {
        transform: translateX(-2px);
        opacity: 0.6;
      }
      50% {
        transform: translateX(2px);
        opacity: 1;
      }
      100% {
        transform: translateX(-2px);
        opacity: 0.6;
      }
    }

    .ws-indicator[data-state="connecting"] .ws-icon {
      animation: wsPulse 1.4s ease-in-out infinite;
    }

    .ws-indicator[data-state="connected"] {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(248, 148, 34, 0.12);
    }

    .ws-indicator[data-state="disconnected"] {
      border-color: rgba(255, 95, 95, 0.6);
      color: #ff8a8a;
      background: rgba(255, 95, 95, 0.12);
    }

    .status-pill[data-active="true"] {
      border-color: var(--accent);
      color: var(--accent);
    }

    .composer {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.07);
      border-radius: 20px;
      padding: 1.05rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      margin-bottom: 1.6rem;
    }

    .composer label {
      font-size: 0.76rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
      font-weight: 600;
    }

    .composer input {
      background: transparent;
      border: none;
      color: inherit;
      font-size: clamp(1.65rem, 3.6vw, 2.2rem);
      font-weight: 600;
      letter-spacing: 0.1em;
      outline: none;
      width: 100%;
    }

    .composer input::placeholder {
      color: rgba(255, 255, 255, 0.22);
    }

    .dialpad-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.85rem;
    }

    .dialpad-key {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 22px;
      background: rgba(255, 255, 255, 0.03);
      color: inherit;
      padding: 0.95rem 0;
      font-size: 1.6rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      transition: transform 120ms ease, border 160ms ease, box-shadow 160ms ease;
      position: relative;
    }

    .dialpad-key span {
      display: block;
      font-size: 0.72rem;
      font-weight: 500;
      letter-spacing: 0.25em;
      color: var(--text-soft);
      margin-top: 0.3rem;
    }

    .dialpad-key:active,
    .dialpad-key:hover {
      transform: translateY(-2px);
      border-color: var(--accent-strong);
      box-shadow: 0 10px 20px rgba(248, 148, 34, 0.18);
    }

    .dialpad-actions,
    .dialpad-secondary {
      margin-top: 1.4rem;
      display: flex;
      gap: 0.9rem;
      align-items: stretch;
      justify-content: center;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding-bottom: 0.4rem;
      scroll-snap-type: x proximity;
      scrollbar-width: thin;
    }

    .dialpad-actions::-webkit-scrollbar,
    .dialpad-secondary::-webkit-scrollbar {
      height: 8px;
    }

    .dialpad-actions::-webkit-scrollbar-track,
    .dialpad-secondary::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 999px;
    }

    .dialpad-actions::-webkit-scrollbar-thumb,
    .dialpad-secondary::-webkit-scrollbar-thumb {
      background: rgba(248, 148, 34, 0.45);
      border-radius: 999px;
    }

    .dialpad-actions > *,
    .dialpad-secondary > * {
      flex: 0 0 clamp(120px, 25%, 180px);
      scroll-snap-align: center;
    }

    .dialpad-secondary {
      margin-top: 0.75rem;
    }

    .pill-btn {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
      color: var(--text-muted);
      font-weight: 600;
      padding: 0.8rem 1.1rem;
      border-radius: 999px;
      cursor: pointer;
      transition: border 160ms ease, color 160ms ease, background 160ms ease, box-shadow 160ms ease;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 0.65rem;
    }

    .btn-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .pill-btn .btn-icon svg {
      width: 18px;
      height: 18px;
      stroke-width: 1.8;
    }

    .pill-btn[data-active="true"] {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(248, 148, 34, 0.12);
      box-shadow: 0 10px 18px rgba(248, 148, 34, 0.25);
    }

    .pill-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .call-btn {
      border-radius: 26px;
      font-size: 1.05rem;
      padding-block: 1rem;
      background: linear-gradient(135deg, rgba(248, 148, 34, 0.95), rgba(248, 148, 34, 0.65));
      color: #121212;
      border: none;
      box-shadow: 0 18px 32px rgba(248, 148, 34, 0.35);
      position: relative;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .call-btn[data-active="true"] {
      background: linear-gradient(135deg, rgba(248, 34, 34, 0.95), rgba(248, 34, 34, 0.7));
      color: #fff;
      box-shadow: 0 18px 32px rgba(248, 34, 34, 0.35);
    }

    .subtext {
      font-size: 0.95rem;
      color: var(--text-soft);
      margin-top: 0.6rem;
      text-align: center;
    }

    .extensions {
      display: flex;
      flex-direction: column;
      gap: 1.3rem;
    }

    .extensions header {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .extensions header h2 {
      font-size: 1.35rem;
      font-weight: 600;
    }

    .extensions header p {
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .extension-list {
      display: grid;
      gap: 0.85rem;
    }

    .extension-card {
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.03);
      padding: 1.15rem 1.25rem;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 1.1rem;
      cursor: pointer;
      transition: transform 160ms ease, border 160ms ease, box-shadow 160ms ease;
    }

    .extension-card:hover {
      transform: translateY(-3px);
      border-color: var(--accent);
      box-shadow: 0 12px 26px rgba(248, 148, 34, 0.18);
    }

    .extension-card .avatar {
      width: 50px;
      height: 50px;
      border-radius: 16px;
      background: rgba(248, 148, 34, 0.16);
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      letter-spacing: 0.06em;
      overflow: hidden;
      position: relative;
    }

    .extension-card .avatar img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 0.4rem;
      box-sizing: border-box;
    }

    .extension-card .avatar--fallback {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text-main);
    }

    .extension-card h3 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .extension-card .subtitle {
      color: var(--text-muted);
      font-size: 0.86rem;
    }

    .extension-card .details {
      color: var(--text-soft);
      font-size: 0.78rem;
      margin-top: 0.35rem;
    }

    .extension-card .extension {
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.1em;
    }

    .empty-hint {
      text-align: center;
      color: var(--text-soft);
      margin-top: 0.8rem;
      font-size: 0.9rem;
    }

    @media (max-width: 960px) {
      body {
        padding: 2.4rem 1.6rem;
      }

      .app {
        grid-template-columns: 1fr;
      }

      header {
        justify-content: space-between;
      }
    }

    @media (max-width: 720px) {
      body {
        padding: 1.9rem 1.25rem;
      }

      .beaverphone {
        gap: 2.1rem;
      }

      .header-title {
        flex: 1 1 100%;
      }

      .dialpad-actions,
      .dialpad-secondary {
        justify-content: flex-start;
      }
    }

    @media (max-width: 540px) {
      .composer {
        padding: 1rem 1.1rem;
      }

      .dialpad-grid {
        gap: 0.75rem;
      }

      .dialpad-actions > *,
      .dialpad-secondary > * {
        flex-basis: min(220px, 80vw);
      }

      .extension-card {
        grid-template-columns: 1fr;
        text-align: center;
      }

      .extension-card .avatar {
        margin: 0 auto;
      }

      .extension-card .extension {
        justify-self: center;
      }
    }
  </style>
</head>
<body>
  <div class="beaverphone">
    <header>
      <div class="header-title">
        <a class="menu-return" href="menu.html" aria-label="Retour au menu" data-i18n-aria-label="header.menuAria">
          <span class="btn-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
              stroke-linejoin="round">
              <path d="M3 9l9-7 9 7"></path>
              <path d="M9 22V12h6v10"></path>
              <path d="M21 10v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V10"></path>
            </svg>
          </span>
        </a>
        <span class="eyebrow" data-i18n="header.brand">BeaverPhone</span>
      </div>
      <div class="lang-toggle" role="group" aria-label="Sélecteur de langue" data-i18n-aria-label="header.languageLabel">
        <button type="button" class="lang-btn active" data-lang="fr" aria-pressed="true">FR</button>
        <button type="button" class="lang-btn" data-lang="en" aria-pressed="false">EN</button>
      </div>
    </header>

    <div class="app">
      <section class="panel" aria-labelledby="dialpad-heading">
        <div class="dialpad-header">
          <h2 id="dialpad-heading" data-i18n="dialpad.heading">Clavier téléphonique</h2>
          <div class="status-cluster">
            <span class="ws-indicator" id="ws-indicator" data-state="connecting">
              <span class="ws-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round">
                  <path d="M12 12h.01"></path>
                  <path d="M16 12h.01"></path>
                  <path d="m17 7 5 5-5 5"></path>
                  <path d="m7 7-5 5 5 5"></path>
                  <path d="M8 12h.01"></path>
                </svg>
              </span>
              <span class="ws-label" data-i18n="dialpad.ws.connecting">Connexion…</span>
            </span>
            <span class="status-pill" id="status-pill" data-active="false">
              <span class="status-text" data-i18n="dialpad.status.ready">Prêt</span>
            </span>
          </div>
        </div>

        <div class="composer">
          <label for="composer-input" data-i18n="dialpad.composerLabel">Composeur</label>
          <input id="composer-input" type="text" inputmode="tel" autocomplete="off"
            placeholder="Touchez les chiffres pour composer" data-i18n-placeholder="dialpad.composerPlaceholder"
            aria-live="polite" />
        </div>

        <div class="dialpad-grid" id="dialpad"></div>

        <div class="dialpad-actions">
          <button type="button" class="pill-btn" id="erase-btn">
            <span class="btn-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <path
                  d="M13 9a1 1 0 0 1-1-1V5.061a1 1 0 0 0-1.811-.75l-6.835 6.836a1.207 1.207 0 0 0 0 1.707l6.835 6.835a1 1 0 0 0 1.811-.75V16a1 1 0 0 1 1-1h2a1 1 0 0 0 1-1v-4a1 1 0 0 0-1-1z">
                </path>
                <path d="M20 9v6"></path>
              </svg>
            </span>
            <span class="btn-label" data-i18n="dialpad.actions.erase">Effacer</span>
          </button>
          <button type="button" class="pill-btn call-btn" id="call-btn">
            <span class="btn-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                stroke-linejoin="round">
                <path
                  d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.82 12.82 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.82 12.82 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                </path>
              </svg>
            </span>
            <span class="btn-label" data-i18n="dialpad.actions.call.idle">Appeler</span>
          </button>
          <button type="button" class="pill-btn" id="speaker-btn">
            <span class="btn-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                stroke-linejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
              </svg>
            </span>
            <span class="btn-label" data-i18n="dialpad.actions.speaker.idle">Haut-parleur</span>
          </button>
        </div>

        <div class="dialpad-secondary">
          <button type="button" class="pill-btn" id="hold-btn" disabled>
            <span class="btn-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round"
                stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="10" x2="10" y1="15" y2="9"></line>
                <line x1="14" x2="14" y1="15" y2="9"></line>
              </svg>
            </span>
            <span class="btn-label" data-i18n="dialpad.actions.hold.idle">Pause</span>
          </button>
          <button type="button" class="pill-btn" id="clear-btn" data-i18n="dialpad.actions.clear">Réinitialiser</button>
        </div>

        
      </section>

      <aside class="panel extensions" aria-labelledby="extension-heading">
        <header>
          <h2 id="extension-heading" data-i18n="extensions.heading">Contacts rapides</h2>
        </header>
        <div class="extension-list" id="extension-list"></div>
      </aside>
    </div>
  </div>

  <script>
    (function () {
      const translations = {
        fr: {
          meta: { title: 'BeaverPhone' },
          header: {
            brand: 'BeaverPhone',
            menuAria: 'Retour au menu',
            languageLabel: 'Sélecteur de langue'
          },
          dialpad: {
            heading: 'Clavier téléphonique',
            ws: {
              connecting: 'Connexion…',
              connected: 'Connecté',
              disconnected: 'Hors ligne'
            },
            status: {
              ready: 'Prêt',
              onCall: 'En appel',
              onHold: 'En attente'
            },
            composerLabel: 'Composeur',
            composerPlaceholder: 'Touchez les chiffres pour composer',
            actions: {
              erase: 'Effacer',
              call: { idle: 'Appeler', active: 'Raccrocher' },
              speaker: { idle: 'Haut-parleur', active: 'Muet' },
              hold: { idle: 'Pause', active: 'Reprendre' },
              clear: 'Réinitialiser'
            },
            helper: {
              idle: 'Touchez les chiffres ou choisissez un contact pour commencer à composer.',
              number: 'Appuyez sur Appeler pour connecter ou sur Effacer pour modifier le numéro.',
              onCall: 'Vous êtes connecté. Utilisez Pause ou Haut-parleur si nécessaire.',
              onHold: 'Appel en attente. Touchez Pause pour reprendre.',
              missing: 'Entrez un numéro ou choisissez un contact d’abord.',
              nothingToErase: 'Rien à effacer.'
            }
          },
          extensions: {
            heading: 'Contacts rapides',
            subtitle: 'Touchez un contact pour appeler automatiquement.',
            empty: 'Aucun contact enregistré.',
            extensionPrefix: 'Poste {{extension}}'
          }
        },
        en: {
          meta: { title: 'BeaverPhone' },
          header: {
            brand: 'BeaverPhone',
            menuAria: 'Back to menu',
            languageLabel: 'Language selector'
          },
          dialpad: {
            heading: 'Dialpad',
            ws: {
              connecting: 'Connecting…',
              connected: 'Connected',
              disconnected: 'Offline'
            },
            status: {
              ready: 'Ready',
              onCall: 'On Call',
              onHold: 'On Hold'
            },
            composerLabel: 'Composer',
            composerPlaceholder: 'Tap numbers to dial',
            actions: {
              erase: 'Erase',
              call: { idle: 'Call', active: 'End' },
              speaker: { idle: 'Speaker', active: 'Mute' },
              hold: { idle: 'Hold', active: 'Resume' },
              clear: 'Clear'
            },
            helper: {
              idle: 'Tap digits or choose a contact to start dialing.',
              number: 'Press Call to connect or Erase to edit the number.',
              onCall: 'You are connected. Use Hold or Speaker as needed.',
              onHold: 'Call is on hold. Tap Hold to resume.',
              missing: 'Enter a number or choose a contact first.',
              nothingToErase: 'Nothing to erase.'
            }
          },
          extensions: {
            heading: 'Extensions',
            subtitle: 'Tap a contact to call automatically.',
            empty: 'No saved extensions yet.',
            extensionPrefix: 'Ext. {{extension}}'
          }
        }
      };

      const state = {
        lang: 'fr'
      };

      const listeners = new Set();
      const langButtons = document.querySelectorAll('.lang-btn');

      const getPreferredLanguage = () => {
        try {
          return localStorage.getItem('preferredLang');
        } catch (error) {
          console.warn('Unable to read preferred language', error);
          return null;
        }
      };

      const format = (template, replacements = {}) => {
        return (template || '').replace(/\{\{(\w+)\}\}/g, (_, token) => {
          return Object.prototype.hasOwnProperty.call(replacements, token)
            ? replacements[token]
            : '';
        });
      };

      const translate = (key, replacements) => {
        if (!key) {
          return '';
        }

        const value = key.split('.').reduce((acc, part) => {
          if (acc && Object.prototype.hasOwnProperty.call(acc, part)) {
            return acc[part];
          }
          return undefined;
        }, translations[state.lang]);

        if (typeof value === 'string') {
          return format(value, replacements);
        }

        return value === undefined ? '' : value;
      };

      const applyStaticTranslations = () => {
        document.querySelectorAll('[data-i18n]').forEach((node) => {
          const key = node.dataset.i18n;
          const value = translate(key);

          if (typeof value === 'string') {
            node.innerHTML = value;
          }
        });

        document.querySelectorAll('[data-i18n-placeholder]').forEach((node) => {
          const key = node.dataset.i18nPlaceholder;
          const value = translate(key);

          if (typeof value === 'string') {
            node.setAttribute('placeholder', value);
          }
        });

        document.querySelectorAll('[data-i18n-aria-label]').forEach((node) => {
          const key = node.dataset.i18nAriaLabel;
          const value = translate(key);

          if (typeof value === 'string') {
            node.setAttribute('aria-label', value);
          }
        });

        document.title = translate('meta.title') || document.title;
      };

      const setLanguage = (lang) => {
        if (!translations[lang]) {
          return;
        }

        state.lang = lang;
        document.documentElement.lang = lang;

        langButtons.forEach((button) => {
          const isActive = button.dataset.lang === lang;
          button.classList.toggle('active', isActive);
          button.setAttribute('aria-pressed', String(isActive));
        });

        applyStaticTranslations();

        listeners.forEach((callback) => {
          try {
            callback(lang);
          } catch (error) {
            console.error('Language listener failed', error);
          }
        });

        try {
          localStorage.setItem('preferredLang', lang);
        } catch (error) {
          console.warn('Unable to persist language preference', error);
        }
      };

      const subscribe = (callback) => {
        if (typeof callback !== 'function') {
          return () => {};
        }

        listeners.add(callback);
        return () => listeners.delete(callback);
      };

      window.beaverPhoneLocale = {
        translate,
        setLanguage,
        subscribe,
        getLanguage: () => state.lang
      };

      langButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const { lang } = button.dataset;
          setLanguage(lang);
        });
      });

      const savedLanguage = getPreferredLanguage();
      if (savedLanguage && translations[savedLanguage]) {
        setLanguage(savedLanguage);
      } else {
        setLanguage(state.lang);
      }
    })();
  </script>

  <script type="module">
  const BEAVERPHONE_DIALPAD_EVENT_KEY = "beaverphone:dialpad";

  const locale = window.beaverPhoneLocale ?? {};
  const translate = (key, replacements) => {
    if (typeof locale.translate === 'function') {
      return locale.translate(key, replacements);
    }
    return key;
  };
  const getLanguage = () => {
    if (typeof locale.getLanguage === 'function') {
      return locale.getLanguage();
    }
    return 'fr';
  };

  const currentDialpadState = {
    dialedNumber: "",
    isOnCall: false,
    isOnHold: false,
    isSpeakerEnabled: false,
  };

  const beaverPhoneConfig = {
    dialpad: [
      { label: "1" }, { label: "2", subtext: "ABC" }, { label: "3", subtext: "DEF" },
      { label: "4" }, { label: "5", subtext: "JKL" }, { label: "6", subtext: "MNO" },
      { label: "7", subtext: "PQRS" }, { label: "8", subtext: "TUV" }, { label: "9", subtext: "WXYZ" },
      { label: "*" }, { label: "0", subtext: "+" }, { label: "#" },
    ],
    contacts: [
      {
        id: 'opp',
        name: { fr: 'Police provinciale de l’Ontario', en: 'Ontario Provincial Police' },
        subtitle: { fr: 'Ligne interne', en: 'Internal line' },
        details: { fr: 'Bureau 101', en: 'Office 101' },
        extension: '1201',
        image: '/contact/Police.png'
      },
      {
        id: 'spca',
        name: { fr: 'SPCA Niagara', en: 'SPCA Niagara' },
        subtitle: { fr: 'Programme Paws Law', en: 'Paws Law program' },
        details: { fr: 'Bureau 3434', en: 'Office 3434' },
        extension: '3434',
        image: '/contact/SPCA.png'
      },
      {
        id: 'mom',
        name: { fr: 'Maman', en: 'Mom' },
        subtitle: { fr: 'Contact direct', en: 'Direct line' },
        details: { fr: 'Bureau des plaintes', en: 'Complaints Office' },
        extension: '22',
        image: null
      },
      {
        id: 'serviceOntario',
        name: { fr: 'Services Ontario', en: 'Services Ontario' },
        subtitle: { fr: 'Gouvernement de l’Ontario', en: 'Government of Ontario' },
        details: { fr: 'Poste *1345', en: 'Desktop *1345' },
        extension: '1345',
        image: '/contact/ontario.svg'
      }
    ],
    dialpadEventKey: BEAVERPHONE_DIALPAD_EVENT_KEY,
  };

  const dialpadEl = document.getElementById("dialpad");
  const composerInput = document.getElementById("composer-input");
  const statusPill = document.getElementById("status-pill");
  const helperText = document.getElementById("helper-text");
  const callBtn = document.getElementById("call-btn");
  const holdBtn = document.getElementById("hold-btn");
  const speakerBtn = document.getElementById("speaker-btn");
  const eraseBtn = document.getElementById("erase-btn");
  const clearBtn = document.getElementById("clear-btn");
  const extensionList = document.getElementById("extension-list");

  const statusText = statusPill.querySelector(".status-text");
  const wsIndicator = document.getElementById("ws-indicator");
  const wsLabel = wsIndicator.querySelector(".ws-label");
  const callBtnLabel = callBtn.querySelector(".btn-label");
  const holdBtnLabel = holdBtn.querySelector(".btn-label");
  const speakerBtnLabel = speakerBtn.querySelector(".btn-label");

  const getLocalizedText = (value) => {
    if (!value) {
      return '';
    }

    if (typeof value === 'string') {
      return value;
    }

    const lang = getLanguage();
    return value?.[lang] ?? value?.en ?? '';
  };

  const setWsIndicator = (state) => {
    if (!wsIndicator || !wsLabel) return;
    wsIndicator.dataset.state = state;
    wsLabel.textContent = translate(`dialpad.ws.${state}`);
  };

  // 🔹 Dispatcher d’événements enrichi avec "action"
  const dispatchDialpadEvent = (action, number = undefined) => {
    const event = new CustomEvent(beaverPhoneConfig.dialpadEventKey, {
      detail: { action, number },
    });
    window.dispatchEvent(event);
  };

  const updateUI = () => {
    composerInput.value = currentDialpadState.dialedNumber;
    callBtn.dataset.active = currentDialpadState.isOnCall;
    callBtnLabel.textContent = translate(
      `dialpad.actions.call.${currentDialpadState.isOnCall ? 'active' : 'idle'}`
    );
    holdBtn.disabled = !currentDialpadState.isOnCall;
    holdBtn.dataset.active = currentDialpadState.isOnHold;
    holdBtnLabel.textContent = translate(
      `dialpad.actions.hold.${currentDialpadState.isOnHold ? 'active' : 'idle'}`
    );
    speakerBtn.dataset.active = currentDialpadState.isSpeakerEnabled;
    speakerBtnLabel.textContent = translate(
      `dialpad.actions.speaker.${currentDialpadState.isSpeakerEnabled ? 'active' : 'idle'}`
    );

    if (currentDialpadState.isOnCall) {
      statusPill.dataset.active = "true";
      statusText.textContent = translate(
        `dialpad.status.${currentDialpadState.isOnHold ? 'onHold' : 'onCall'}`
      );
      helperText.textContent = translate(
        currentDialpadState.isOnHold ? 'dialpad.helper.onHold' : 'dialpad.helper.onCall'
      );
    } else if (currentDialpadState.dialedNumber.length > 0) {
      statusPill.dataset.active = "false";
      statusText.textContent = translate('dialpad.status.ready');
      helperText.textContent = translate('dialpad.helper.number');
    } else {
      statusPill.dataset.active = "false";
      statusText.textContent = translate('dialpad.status.ready');
      helperText.textContent = translate('dialpad.helper.idle');
    }
  };

  // 🔹 Ajout des touches numériques
  const appendDigit = (digit) => {
    currentDialpadState.dialedNumber += digit;
    dispatchDialpadEvent("dtmf", digit);
    updateUI();
  };

  const eraseDigit = () => {
    if (!currentDialpadState.dialedNumber) return;
    currentDialpadState.dialedNumber = currentDialpadState.dialedNumber.slice(0, -1);
    updateUI();
  };

  const resetDialer = () => {
    currentDialpadState.dialedNumber = "";
    currentDialpadState.isOnCall = false;
    currentDialpadState.isOnHold = false;
    updateUI();
  };

  beaverPhoneConfig.dialpad.forEach((item) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "dialpad-key";
    btn.textContent = item.label;
    if (item.subtext) {
      const sub = document.createElement("span");
      sub.textContent = item.subtext;
      btn.appendChild(sub);
    }
    btn.addEventListener("click", () => appendDigit(item.label));
    dialpadEl.appendChild(btn);
  });

  // 🔹 Bouton Call → envoie "dial" ou "hangup"
  callBtn.addEventListener("click", () => {
    if (!currentDialpadState.isOnCall && currentDialpadState.dialedNumber.length === 0) {
      helperText.textContent = translate('dialpad.helper.missing');
      return;
    }
    currentDialpadState.isOnCall = !currentDialpadState.isOnCall;

    if (currentDialpadState.isOnCall) {
      dispatchDialpadEvent("dial", currentDialpadState.dialedNumber);
    } else {
      dispatchDialpadEvent("hangup");
    }

    updateUI();
  });

  holdBtn.addEventListener("click", () => {
    if (!currentDialpadState.isOnCall) return;
    currentDialpadState.isOnHold = !currentDialpadState.isOnHold;
    updateUI();
  });

  speakerBtn.addEventListener("click", () => {
    currentDialpadState.isSpeakerEnabled = !currentDialpadState.isSpeakerEnabled;
    updateUI();
  });

  eraseBtn.addEventListener("click", () => {
    if (currentDialpadState.dialedNumber.length === 0) {
      helperText.textContent = translate('dialpad.helper.nothingToErase');
      return;
    }
    eraseDigit();
  });

  clearBtn.addEventListener("click", () => {
    resetDialer();
    dispatchDialpadEvent("clear");
  });

  composerInput.addEventListener("input", (event) => {
    const { value } = event.target;
    currentDialpadState.dialedNumber = value.replace(/[^0-9*#]/g, "");
    updateUI();
  });

  composerInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      callBtn.click();
    } else if (event.key === "Backspace" && event.metaKey) {
      resetDialer();
      dispatchDialpadEvent("clear");
    }
  });

  window.addEventListener("beaverphone:ws-status", (event) => {
    const { status } = event.detail || {};

    switch (status) {
      case "connected":
        setWsIndicator("connected");
        break;
      case "disconnected":
        setWsIndicator("disconnected");
        break;
      case "connecting":
      default:
        setWsIndicator("connecting");
        break;
    }
  });

  const renderExtensions = () => {
    if (!extensionList) {
      return;
    }

    extensionList.innerHTML = '';

    if (beaverPhoneConfig.contacts.length === 0) {
      const emptyState = document.createElement('p');
      emptyState.className = 'empty-hint';
      emptyState.textContent = translate('extensions.empty');
      extensionList.appendChild(emptyState);
      return;
    }

    beaverPhoneConfig.contacts.forEach((contact) => {
      const card = document.createElement('article');
      card.className = 'extension-card';

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.setAttribute('aria-hidden', 'true');

      const localizedName = getLocalizedText(contact.name);

      if (contact.image) {
        const img = document.createElement('img');
        img.src = contact.image;
        img.alt = `${localizedName} avatar`;
        img.addEventListener('error', () => {
          img.remove();
          avatar.classList.add('avatar--fallback');
          avatar.textContent = (localizedName || '').slice(0, 1).toUpperCase();
        });
        avatar.appendChild(img);
      } else {
        avatar.classList.add('avatar--fallback');
        avatar.textContent = (localizedName || '').slice(0, 1).toUpperCase();
      }

      const info = document.createElement('div');
      const nameEl = document.createElement('h3');
      nameEl.textContent = localizedName;
      const subtitleEl = document.createElement('div');
      subtitleEl.className = 'subtitle';
      subtitleEl.textContent = getLocalizedText(contact.subtitle);
      const detailsEl = document.createElement('div');
      detailsEl.className = 'details';
      detailsEl.textContent = getLocalizedText(contact.details);
      info.appendChild(nameEl);
      info.appendChild(subtitleEl);
      info.appendChild(detailsEl);

      const extension = document.createElement('div');
      extension.className = 'extension';
      extension.textContent = translate('extensions.extensionPrefix', {
        extension: contact.extension
      });

      card.appendChild(avatar);
      card.appendChild(info);
      card.appendChild(extension);

      card.addEventListener('click', () => {
        currentDialpadState.dialedNumber = contact.extension;
        currentDialpadState.isOnCall = true;
        currentDialpadState.isOnHold = false;
        dispatchDialpadEvent('dial', contact.extension);
        updateUI();
      });
      extensionList.appendChild(card);
    });
  };

  const refreshLocalizedUI = () => {
    renderExtensions();
    setWsIndicator(wsIndicator?.dataset.state || 'connecting');
    updateUI();
  };

  if (typeof locale.subscribe === 'function') {
    locale.subscribe(() => {
      refreshLocalizedUI();
    });
  }

  refreshLocalizedUI();
</script>
