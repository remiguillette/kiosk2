<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Beavertask - Calendar</title>
    <style>
      :root {
        --bg-primary: #000000;
        --bg-secondary: #0a0a0a;
        --text-primary: #ffffff;
        --text-secondary: #999999;
        --text-muted: #666666;
        --accent: #f89422;
        --accent-dim: rgba(248, 148, 34, 0.2);
        --border: #1a1a1a;
        --card-bg: #0f0f0f;
        --sidebar-width: 60px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      html::-webkit-scrollbar,
      body::-webkit-scrollbar {
        display: none;
      }

      .app-container {
        display: flex;
        height: 100vh;
        width: 100vw;
        padding-left: var(--sidebar-width);
      }

      .sidebar {
        width: var(--sidebar-width);
        background: var(--bg-secondary);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 0;
        gap: 30px;
        border-right: 1px solid var(--border);
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 2;
      }

      .sidebar-back {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        text-decoration: none;
        color: var(--text-primary);
        transition: color 0.2s, opacity 0.2s;
        margin-bottom: 10px;
        cursor: pointer;
        opacity: 0.7;
      }

      .sidebar-back svg {
        width: 24px;
        height: 24px;
        stroke: currentColor;
      }

      .sidebar-back:hover {
        color: var(--accent);
        opacity: 1;
      }

      .sidebar-icon {
        width: 24px;
        height: 24px;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .sidebar-icon:hover {
        opacity: 1;
      }

      .sidebar-icon.active {
        opacity: 1;
        color: var(--accent);
      }

      .main-content {
        flex: 1;
        display: flex;
        overflow: hidden;
      }

      .calendar-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 40px;
        max-width: 650px;
      }

      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 40px;
      }

      .month-display {
        font-size: 24px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 2px;
      }

      .header-controls {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .icon-btn {
        background: transparent;
        border: none;
        color: var(--text-primary);
        cursor: pointer;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .current-day-badge {
        background: var(--text-primary);
        color: var(--bg-primary);
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 14px;
        font-weight: 600;
      }

      .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 8px;
      }

      .weekday {
        text-align: center;
        font-size: 11px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        padding: 8px 0;
        letter-spacing: 1px;
      }

      .weekday.dim {
        color: var(--accent);
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        flex: 1;
      }

      .calendar-cell {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        min-height: 60px;
        padding: 8px;
      }

      .calendar-cell:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .calendar-cell.inactive {
        opacity: 0.3;
      }

      .calendar-cell.today {
        border: 2px solid var(--accent);
      }

      .calendar-cell.selected {
        background: transparent;
        position: relative;
      }

      .calendar-cell.selected::after {
        content: '';
        position: absolute;
        bottom: 8px;
        left: 50%;
        transform: translateX(-50%);
        width: 32px;
        height: 3px;
        background: var(--text-primary);
        border-radius: 2px;
      }

      .calendar-cell.has-events::before {
        content: '';
        position: absolute;
        top: 8px;
        right: 8px;
        width: 4px;
        height: 4px;
        background: var(--accent);
        border-radius: 50%;
      }

      .cell-date {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .details-panel {
        flex: 1;
        background: var(--bg-secondary);
        padding: 40px;
        display: flex;
        flex-direction: column;
        border-left: 1px solid var(--border);
        overflow-y: auto;
      }

      .details-header {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 30px;
      }

      .details-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        text-align: center;
      }

      .empty-icon {
        font-size: 48px;
        opacity: 0.5;
      }

      .empty-text {
        color: var(--text-secondary);
        font-size: 14px;
      }

      .event-input {
        width: 100%;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px 20px;
        color: var(--text-primary);
        font-size: 15px;
        margin-top: auto;
        transition: border-color 0.2s;
      }

      .event-input:focus {
        outline: none;
        border-color: var(--accent);
      }

      .event-input::placeholder {
        color: var(--text-muted);
      }

      .fab {
        position: fixed;
        bottom: 40px;
        right: 40px;
        width: 56px;
        height: 56px;
        background: var(--text-secondary);
        border: none;
        border-radius: 50%;
        color: var(--bg-primary);
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        transition: all 0.2s;
      }

      .fab:hover {
        background: var(--text-primary);
        transform: scale(1.1);
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        padding: 24px;
      }

      .modal-overlay[hidden] {
        display: none;
      }

      .modal-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 32px;
        width: min(420px, 100%);
        box-shadow: 0 18px 42px rgba(0, 0, 0, 0.45);
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .modal-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .modal-description {
        font-size: 14px;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      .modal-form {
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      .modal-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .modal-label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .modal-input,
      .modal-textarea,
      .modal-select {
        width: 100%;
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px 16px;
        color: var(--text-primary);
        font-size: 15px;
        transition: border-color 0.2s ease;
      }

      .modal-textarea {
        resize: vertical;
        min-height: 90px;
      }

      .modal-input:focus,
      .modal-textarea:focus,
      .modal-select:focus {
        outline: none;
        border-color: var(--accent);
      }

      .modal-actions {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .modal-btn {
        border: none;
        border-radius: 999px;
        padding: 12px 22px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s ease, background 0.2s ease;
      }

      .modal-btn.primary {
        background: var(--accent);
        color: var(--bg-primary);
      }

      .modal-btn.secondary {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
      }

      .modal-btn:hover {
        transform: translateY(-1px);
      }

      .modal-btn.primary:hover {
        background: #ffa648;
      }

      .modal-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      .task-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 20px;
      }

      .task-item {
        background: var(--card-bg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: background 0.2s;
      }

      .task-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }

      .task-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid var(--text-secondary);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .task-checkbox.completed {
        background: var(--accent);
        border-color: var(--accent);
        position: relative;
      }

      .task-checkbox.completed::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: var(--bg-primary);
        font-size: 12px;
        font-weight: bold;
      }

      .task-info {
        flex: 1;
      }

      .task-title {
        font-size: 15px;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .task-meta {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .task-actions {
        display: flex;
        gap: 8px;
      }

      .task-action-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 4px;
        font-size: 14px;
        transition: color 0.2s;
      }

      .task-action-btn:hover {
        color: var(--text-primary);
      }

      .task-action-btn.delete:hover {
        color: #ff4444;
      }

      @media (max-width: 1024px) {
        :root {
          --sidebar-width: 50px;
        }

        .sidebar {
          padding: 15px 0;
        }

        .calendar-section {
          padding: 20px;
        }

        .details-panel {
          padding: 20px;
        }
      }

      .tasklist-section {
        flex: 1;
        display: none;
        flex-direction: column;
        padding: 40px;
        overflow-y: auto;
      }

      .tasklist-section.active {
        display: flex;
      }

      .tasklist-header {
        font-size: 24px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 40px;
      }

      .tasklist-content {
        flex: 1;
      }

      .tasklist-group {
        margin-bottom: 30px;
      }

      .tasklist-group-title {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 12px;
      }

      .tasklist-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 300px;
        gap: 20px;
        text-align: center;
      }

      @media (max-width: 768px) {
        :root {
          --sidebar-width: 48px;
        }

        .sidebar {
          padding: 12px 0;
        }

        .main-content {
          flex-direction: column;
        }

        .calendar-section {
          max-width: 100%;
          padding: 20px;
        }

        .details-panel {
          border-left: none;
          border-top: 1px solid var(--border);
        }

        .tasklist-section {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <aside class="sidebar">
        <a class="sidebar-back" href="menu.html" aria-label="Back to menu">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
            <path d="M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8"></path>
          </svg>
        </a>
        <div class="sidebar-icon active" id="calendar-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
        <div class="sidebar-icon" id="tasklist-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="8" y1="6" x2="21" y2="6"></line>
            <line x1="8" y1="12" x2="21" y2="12"></line>
            <line x1="8" y1="18" x2="21" y2="18"></line>
            <line x1="3" y1="6" x2="3.01" y2="6"></line>
            <line x1="3" y1="12" x2="3.01" y2="12"></line>
            <line x1="3" y1="18" x2="3.01" y2="18"></line>
          </svg>
        </div>
      </aside>

      <div class="main-content">
        <section class="calendar-section">
          <div class="calendar-header">
            <button class="icon-btn" id="prev-month">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
              </svg>
            </button>
            <div class="month-display" id="month-display">OCT.</div>
            <button class="icon-btn" id="next-month">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="9 18 15 12 9 6"></polyline>
              </svg>
            </button>
            <div class="header-controls">
              <button class="icon-btn" id="search-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="11" cy="11" r="8"></circle>
                  <path d="m21 21-4.35-4.35"></path>
                </svg>
              </button>
              <div class="current-day-badge" id="current-day-badge">14</div>
            </div>
          </div>

          <div class="weekdays">
            <div class="weekday dim">SUN</div>
            <div class="weekday">MON</div>
            <div class="weekday">TUE</div>
            <div class="weekday">WED</div>
            <div class="weekday">THU</div>
            <div class="weekday">FRI</div>
            <div class="weekday">SAT</div>
          </div>

          <div class="calendar-grid" id="calendar-grid"></div>
        </section>

        <section class="details-panel">
          <div class="details-header" id="details-header">14 Oct.</div>

          <div class="details-content" id="details-content">
            <div class="empty-state">
              <div class="empty-icon">☺</div>
              <div class="empty-text">Appuyez pour ajouter un autocollant à cette journée.</div>
            </div>
          </div>

          <input 
            type="text" 
            class="event-input" 
            id="event-input" 
            placeholder="Ajout évén. le 14 oct."
          />
        </section>

        <section class="tasklist-section" id="tasklist-section">
          <div class="tasklist-header">TASK LIST</div>
          <div class="tasklist-content" id="tasklist-content">
            <div class="tasklist-empty">
              <div class="empty-icon">📋</div>
              <div class="empty-text">No tasks yet. Add your first task!</div>
            </div>
          </div>
        </section>
      </div>

      <button class="fab" id="add-btn">
        <span>+</span>
      </button>

      <div class="modal-overlay" id="task-modal" hidden>
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
          <h2 class="modal-title" id="task-modal-title">Nouvel événement</h2>
          <p class="modal-description" id="task-modal-description">
            Ajoutez un rappel personnalisé à votre calendrier BeaverTask.
          </p>
          <form class="modal-form" id="task-form">
            <div class="modal-field">
              <label class="modal-label" for="task-title">Titre</label>
              <input
                class="modal-input"
                type="text"
                id="task-title"
                name="title"
                placeholder="Ex. Rendez-vous"
                required
                autocomplete="off"
              />
            </div>

            <div class="modal-field">
              <label class="modal-label" for="task-tag">Catégorie</label>
              <input
                class="modal-input"
                type="text"
                id="task-tag"
                name="tag"
                placeholder="Ex. Santé, Travail, Famille"
                autocomplete="off"
              />
            </div>

            <div class="modal-field">
              <label class="modal-label" for="task-description">Notes</label>
              <textarea
                class="modal-textarea"
                id="task-description"
                name="description"
                placeholder="Ajoutez des détails importants..."
              ></textarea>
            </div>

            <div class="modal-actions">
              <button type="button" class="modal-btn secondary" id="task-cancel">Annuler</button>
              <button type="submit" class="modal-btn primary">Ajouter</button>
            </div>
          </form>
        </div>
      </div>

      <div class="modal-overlay" id="date-jump-modal" hidden>
        <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="date-jump-title">
          <h2 class="modal-title" id="date-jump-title">Aller à une date</h2>
          <p class="modal-description">
            Sélectionnez une date pour y accéder rapidement.
          </p>
          <form class="modal-form" id="date-jump-form">
            <div class="modal-field">
              <label class="modal-label" for="jump-date">Date</label>
              <input class="modal-input" type="date" id="jump-date" name="date" required />
            </div>

            <div class="modal-actions">
              <button type="button" class="modal-btn secondary" id="date-jump-cancel">Annuler</button>
              <button type="submit" class="modal-btn primary">Aller</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
      const API_ENDPOINT = '/api/tasks';

      const state = {
        tasks: [],
        currentYear: new Date().getFullYear(),
        currentMonth: new Date().getMonth(),
        selectedDate: null,
      };

      const monthNames = ["JAN.", "FEB.", "MAR.", "APR.", "MAY", "JUN.", "JUL.", "AUG.", "SEP.", "OCT.", "NOV.", "DEC."];
      const monthNamesFull = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

      const requestJson = async (url, options = {}) => {
        let response;
        try {
          response = await fetch(url, {
            headers: {
              Accept: 'application/json',
              ...(options.body ? { 'Content-Type': 'application/json' } : {}),
              ...(options.headers || {}),
            },
            ...options,
          });
        } catch (networkError) {
          throw new Error(networkError?.message || 'Network request failed');
        }

        const contentType = response.headers.get('content-type') || '';
        const isJson = contentType.includes('application/json');

        if (!response.ok) {
          let message = `Request failed with status ${response.status}`;

          if (isJson) {
            try {
              const errorPayload = await response.json();
              if (errorPayload && typeof errorPayload.error === 'string') {
                message = errorPayload.error;
              }
            } catch (jsonError) {
              console.error('Failed to parse error payload:', jsonError);
            }
          } else {
            try {
              const text = await response.text();
              if (text) {
                message = text;
              }
            } catch (textError) {
              console.error('Failed to read error response:', textError);
            }
          }

          throw new Error(message);
        }

        if (response.status === 204) {
          return null;
        }

        if (!isJson) {
          return null;
        }

        return response.json();
      };

      const loadTasks = async () => {
        try {
          const payload = await requestJson(API_ENDPOINT);
          if (payload && Array.isArray(payload.tasks)) {
            return payload.tasks.map(normalizeTask).filter(Boolean);
          }
          return [];
        } catch (error) {
          console.error('Failed to load tasks from server:', error);
          return null;
        }
      };

      const refreshTasks = async () => {
        const tasks = await loadTasks();
        if (Array.isArray(tasks)) {
          state.tasks = tasks;
          return true;
        }
        return false;
      };

      const normalizeTask = (task) => {
        if (!task || typeof task !== "object") {
          return null;
        }

        const createdAt = typeof task.createdAt === "string" ? task.createdAt : new Date().toISOString();
        const updatedAt = typeof task.updatedAt === "string" ? task.updatedAt : createdAt;

        return {
          id: task.id || Date.now().toString() + Math.random().toString(36).substr(2, 9),
          title: task.title ?? "",
          description: task.description ?? "",
          dueDate: typeof task.dueDate === "string" && task.dueDate ? task.dueDate : null,
          tag: task.tag ?? "",
          completed: Boolean(task.completed),
          createdAt,
          updatedAt,
        };
      };

      const addTask = async (taskInput) => {
        try {
          const created = await requestJson(API_ENDPOINT, {
            method: 'POST',
            body: JSON.stringify(taskInput),
          });
          const normalized = normalizeTask(created);
          if (normalized) {
            state.tasks = [...state.tasks.filter((task) => task.id !== normalized.id), normalized];
          }
          await refreshTasks();
          rerenderAll();
          return true;
        } catch (error) {
          console.error('Failed to add task:', error);
          return false;
        }
      };

      const updateTask = async (id, updates) => {
        try {
          const updated = await requestJson(`${API_ENDPOINT}/${encodeURIComponent(id)}`, {
            method: 'PATCH',
            body: JSON.stringify(updates),
          });
          const normalized = normalizeTask(updated);
          if (normalized) {
            const index = state.tasks.findIndex((task) => task.id === normalized.id);
            if (index >= 0) {
              state.tasks[index] = normalized;
            } else {
              state.tasks = [...state.tasks, normalized];
            }
          }
          await refreshTasks();
          rerenderAll();
          return true;
        } catch (error) {
          console.error('Failed to update task:', error);
          return false;
        }
      };

      const deleteTask = async (id) => {
        try {
          await requestJson(`${API_ENDPOINT}/${encodeURIComponent(id)}`, {
            method: 'DELETE',
          });
          state.tasks = state.tasks.filter((task) => task.id !== id);
          await refreshTasks();
          rerenderAll();
          return true;
        } catch (error) {
          console.error('Failed to delete task:', error);
          return false;
        }
      };

      const getDateKey = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const ensureSelectedDate = () => {
        if (!(state.selectedDate instanceof Date)) {
          state.selectedDate = new Date();
        }
      };

      const parseDateInput = (value) => {
        if (!value || typeof value !== 'string') {
          return new Date();
        }

        const [year, month, day] = value.split('-').map(Number);
        if (!year || !month || !day) {
          return new Date();
        }

        return new Date(year, month - 1, day);
      };

      const renderCalendar = () => {
        const grid = document.getElementById('calendar-grid');
        const monthDisplay = document.getElementById('month-display');

        monthDisplay.textContent = monthNames[state.currentMonth];

        grid.innerHTML = '';

        const firstDay = new Date(state.currentYear, state.currentMonth, 1);
        const lastDay = new Date(state.currentYear, state.currentMonth + 1, 0);
        const startDay = firstDay.getDay();
        const totalDays = lastDay.getDate();

        const today = new Date();
        const todayKey = getDateKey(today);

        const taskMap = state.tasks.reduce((map, task) => {
          if (task.dueDate) {
            if (!map.has(task.dueDate)) {
              map.set(task.dueDate, []);
            }
            map.get(task.dueDate).push(task);
          }
          return map;
        }, new Map());

        for (let i = 0; i < startDay; i++) {
          const prevMonthDay = new Date(state.currentYear, state.currentMonth, -startDay + i + 1);
          const cell = createCalendarCell(prevMonthDay, true, taskMap);
          grid.appendChild(cell);
        }

        for (let day = 1; day <= totalDays; day++) {
          const date = new Date(state.currentYear, state.currentMonth, day);
          const cell = createCalendarCell(date, false, taskMap);
          grid.appendChild(cell);
        }

        const cellsCount = grid.children.length;
        const remainingCells = Math.ceil(cellsCount / 7) * 7 - cellsCount;
        for (let i = 1; i <= remainingCells; i++) {
          const nextMonthDay = new Date(state.currentYear, state.currentMonth + 1, i);
          const cell = createCalendarCell(nextMonthDay, true, taskMap);
          grid.appendChild(cell);
        }
      };

      const createCalendarCell = (date, inactive, taskMap) => {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell';

        const dateKey = getDateKey(date);
        const today = new Date();
        const todayKey = getDateKey(today);

        if (inactive) {
          cell.classList.add('inactive');
        }

        if (dateKey === todayKey) {
          cell.classList.add('today');
        }

        if (state.selectedDate && getDateKey(state.selectedDate) === dateKey) {
          cell.classList.add('selected');
        }

        if (taskMap.has(dateKey)) {
          cell.classList.add('has-events');
        }

        const dateSpan = document.createElement('span');
        dateSpan.className = 'cell-date';
        dateSpan.textContent = date.getDate();
        cell.appendChild(dateSpan);

        cell.addEventListener('click', () => {
          state.selectedDate = date;
          renderCalendar();
          renderDetails();
        });

        return cell;
      };

      const renderDetails = () => {
        const detailsHeader = document.getElementById('details-header');
        const detailsContent = document.getElementById('details-content');
        const eventInput = document.getElementById('event-input');

        ensureSelectedDate();

        const dateKey = getDateKey(state.selectedDate);
        const day = state.selectedDate.getDate();
        const month = monthNamesFull[state.selectedDate.getMonth()].substring(0, 3);

        detailsHeader.textContent = `${day} ${month}.`;
        eventInput.placeholder = `Ajout évén. le ${day} ${month.toLowerCase()}.`;

        const tasksForDate = state.tasks.filter(task => task.dueDate === dateKey);

        if (tasksForDate.length === 0) {
          detailsContent.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">☺</div>
              <div class="empty-text">Appuyez pour ajouter un autocollant à cette journée.</div>
            </div>
          `;
        } else {
          const taskListHTML = tasksForDate.map(task => `
            <div class="task-item">
              <div class="task-checkbox ${task.completed ? 'completed' : ''}" data-id="${task.id}"></div>
              <div class="task-info">
                <div class="task-title">${task.title}</div>
                ${task.tag ? `<div class="task-meta">${task.tag}</div>` : ''}
              </div>
              <div class="task-actions">
                <button class="task-action-btn delete" data-action="delete" data-id="${task.id}">×</button>
              </div>
            </div>
          `).join('');

          detailsContent.innerHTML = `<div class="task-list">${taskListHTML}</div>`;

          detailsContent.querySelectorAll('.task-checkbox').forEach((checkbox) => {
            checkbox.addEventListener('click', async (event) => {
              const id = event.currentTarget.dataset.id;
              const task = state.tasks.find((t) => t.id === id);
              if (task) {
                await updateTask(id, { completed: !task.completed });
              }
            });
          });

          detailsContent.querySelectorAll('.task-action-btn.delete').forEach((btn) => {
            btn.addEventListener('click', async (event) => {
              const id = event.currentTarget.dataset.id;
              if (confirm('Delete this task?')) {
                await deleteTask(id);
              }
            });
          });
        }
      };

      const changeMonth = (offset) => {
        state.currentMonth += offset;
        if (state.currentMonth < 0) {
          state.currentMonth = 11;
          state.currentYear -= 1;
        } else if (state.currentMonth > 11) {
          state.currentMonth = 0;
          state.currentYear += 1;
        }
        renderCalendar();
        renderDetails();
      };

      const updateCurrentDayBadge = () => {
        const today = new Date();
        const badge = document.getElementById('current-day-badge');
        badge.textContent = today.getDate();
      };

      const addBtn = document.getElementById('add-btn');
      const taskModal = document.getElementById('task-modal');
      const taskForm = document.getElementById('task-form');
      const taskTitleInput = document.getElementById('task-title');
      const taskTagInput = document.getElementById('task-tag');
      const taskDescriptionInput = document.getElementById('task-description');
      const taskCancelBtn = document.getElementById('task-cancel');
      const taskModalDescription = document.getElementById('task-modal-description');

      const openTaskModal = () => {
        if (!taskModal) {
          return;
        }

        ensureSelectedDate();
        const day = state.selectedDate.getDate();
        const month = monthNamesFull[state.selectedDate.getMonth()];
        const year = state.selectedDate.getFullYear();
        
        taskModalDescription.textContent = `Ajouter un événement pour le ${day} ${month} ${year}.`;
        
        taskModal.removeAttribute('hidden');
        requestAnimationFrame(() => {
          taskTitleInput?.focus();
        });
      };

      const closeTaskModal = () => {
        if (!taskModal) {
          return;
        }

        taskModal.setAttribute('hidden', '');
        taskForm?.reset();
      };

      document.getElementById('prev-month').addEventListener('click', () => changeMonth(-1));
      document.getElementById('next-month').addEventListener('click', () => changeMonth(1));

      addBtn?.addEventListener('click', openTaskModal);

      taskCancelBtn?.addEventListener('click', closeTaskModal);

      taskModal?.addEventListener('click', (event) => {
        if (event.target === taskModal) {
          closeTaskModal();
        }
      });

      taskForm?.addEventListener('submit', async (event) => {
        event.preventDefault();

        const title = taskTitleInput?.value.trim();
        if (!title) {
          taskTitleInput?.focus();
          return;
        }

        ensureSelectedDate();
        const descriptionValue = taskDescriptionInput?.value.trim() ?? '';
        const tagValue = taskTagInput?.value.trim() ?? '';

        const success = await addTask({
          title,
          dueDate: getDateKey(state.selectedDate),
          description: descriptionValue,
          tag: tagValue,
          completed: false,
        });

        if (success) {
          closeTaskModal();
        }
      });

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (taskModal && !taskModal.hasAttribute('hidden')) {
            closeTaskModal();
          } else if (dateJumpModal && !dateJumpModal.hasAttribute('hidden')) {
            closeDateJumpModal();
          }
        }
      });

      const quickAddInput = document.getElementById('event-input');
      quickAddInput?.addEventListener('keypress', async (event) => {
        if (event.key === 'Enter') {
          const target = event.target;
          if (!(target instanceof HTMLInputElement)) {
            return;
          }

          const value = target.value.trim();
          if (!value) {
            return;
          }

          ensureSelectedDate();
          const dateKey = getDateKey(state.selectedDate);

          const success = await addTask({
            title: value,
            dueDate: dateKey,
            description: '',
            tag: '',
            completed: false,
          });

          if (success) {
            target.value = '';
          }
        }
      });

      const dateJumpModal = document.getElementById('date-jump-modal');
      const dateJumpForm = document.getElementById('date-jump-form');
      const jumpDateInput = document.getElementById('jump-date');
      const dateJumpCancelBtn = document.getElementById('date-jump-cancel');

      const openDateJumpModal = () => {
        if (!dateJumpModal) {
          return;
        }

        ensureSelectedDate();
        jumpDateInput.value = getDateKey(state.selectedDate);
        
        dateJumpModal.removeAttribute('hidden');
        requestAnimationFrame(() => {
          jumpDateInput?.focus();
        });
      };

      const closeDateJumpModal = () => {
        if (!dateJumpModal) {
          return;
        }

        dateJumpModal.setAttribute('hidden', '');
        dateJumpForm?.reset();
      };

      document.getElementById('search-btn').addEventListener('click', openDateJumpModal);

      dateJumpCancelBtn?.addEventListener('click', closeDateJumpModal);

      dateJumpModal?.addEventListener('click', (event) => {
        if (event.target === dateJumpModal) {
          closeDateJumpModal();
        }
      });

      dateJumpForm?.addEventListener('submit', (event) => {
        event.preventDefault();

        const dateValue = jumpDateInput?.value;
        if (!dateValue) {
          return;
        }

        const targetDate = parseDateInput(dateValue);
        state.currentYear = targetDate.getFullYear();
        state.currentMonth = targetDate.getMonth();
        state.selectedDate = targetDate;
        
        renderCalendar();
        renderDetails();
        closeDateJumpModal();
      });

      const showCalendarView = () => {
        document.querySelector('.calendar-section').style.display = 'flex';
        document.querySelector('.details-panel').style.display = 'flex';
        document.getElementById('tasklist-section').classList.remove('active');
        document.getElementById('calendar-icon').classList.add('active');
        document.getElementById('tasklist-icon').classList.remove('active');
      };

      const showTaskListView = () => {
        document.querySelector('.calendar-section').style.display = 'none';
        document.querySelector('.details-panel').style.display = 'none';
        document.getElementById('tasklist-section').classList.add('active');
        document.getElementById('calendar-icon').classList.remove('active');
        document.getElementById('tasklist-icon').classList.add('active');
        renderTaskList();
      };

      const renderTaskList = () => {
        const tasklistContent = document.getElementById('tasklist-content');

        if (state.tasks.length === 0) {
          tasklistContent.innerHTML = `
            <div class="tasklist-empty">
              <div class="empty-icon">📋</div>
              <div class="empty-text">No tasks yet. Add your first task!</div>
            </div>
          `;
          return;
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const incomplete = state.tasks.filter(t => !t.completed);
        const completed = state.tasks.filter(t => t.completed);
        
        const upcoming = incomplete.filter(t => {
          if (!t.dueDate) return false;
          const taskDate = new Date(t.dueDate);
          return taskDate >= today;
        }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        const overdue = incomplete.filter(t => {
          if (!t.dueDate) return false;
          const taskDate = new Date(t.dueDate);
          return taskDate < today;
        }).sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

        const noDueDate = incomplete.filter(t => !t.dueDate);
        
        let html = '';

        if (overdue.length > 0) {
          html += `
            <div class="tasklist-group">
              <div class="tasklist-group-title">Overdue (${overdue.length})</div>
              <div class="task-list">
                ${overdue.map(task => renderTaskListItem(task)).join('')}
              </div>
            </div>
          `;
        }

        if (upcoming.length > 0) {
          html += `
            <div class="tasklist-group">
              <div class="tasklist-group-title">Upcoming (${upcoming.length})</div>
              <div class="task-list">
                ${upcoming.map(task => renderTaskListItem(task)).join('')}
              </div>
            </div>
          `;
        }

        if (noDueDate.length > 0) {
          html += `
            <div class="tasklist-group">
              <div class="tasklist-group-title">No Due Date (${noDueDate.length})</div>
              <div class="task-list">
                ${noDueDate.map(task => renderTaskListItem(task)).join('')}
              </div>
            </div>
          `;
        }

        if (completed.length > 0) {
          html += `
            <div class="tasklist-group">
              <div class="tasklist-group-title">Completed (${completed.length})</div>
              <div class="task-list">
                ${completed.map(task => renderTaskListItem(task)).join('')}
              </div>
            </div>
          `;
        }

        tasklistContent.innerHTML = html;

        tasklistContent.querySelectorAll('.task-checkbox').forEach((checkbox) => {
          checkbox.addEventListener('click', async (event) => {
            const id = event.currentTarget.dataset.id;
            const task = state.tasks.find((t) => t.id === id);
            if (task) {
              await updateTask(id, { completed: !task.completed });
            }
          });
        });

        tasklistContent.querySelectorAll('.task-action-btn.delete').forEach((btn) => {
          btn.addEventListener('click', async (event) => {
            const id = event.currentTarget.dataset.id;
            if (confirm('Delete this task?')) {
              await deleteTask(id);
            }
          });
        });
      };

      function rerenderAll() {
        renderCalendar();
        renderDetails();
        renderTaskList();
      }

      const renderTaskListItem = (task) => {
        const formattedDate = task.dueDate
          ? new Date(task.dueDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
          : 'No due date';
        
        const tagDisplay = task.tag ? ` • ${task.tag}` : '';
        
        return `
          <div class="task-item">
            <div class="task-checkbox ${task.completed ? 'completed' : ''}" data-id="${task.id}"></div>
            <div class="task-info">
              <div class="task-title">${task.title}</div>
              <div class="task-meta">${formattedDate}${tagDisplay}</div>
            </div>
            <div class="task-actions">
              <button class="task-action-btn delete" data-id="${task.id}">🗑️</button>
            </div>
          </div>
        `;
      };

      document.getElementById('calendar-icon').addEventListener('click', showCalendarView);
      document.getElementById('tasklist-icon').addEventListener('click', showTaskListView);

      const init = async () => {
        await refreshTasks();
        state.selectedDate = new Date();
        updateCurrentDayBadge();
        rerenderAll();
      };

      init().catch((error) => {
        console.error('Failed to initialize BeaverTask:', error);
      });
    </script>
  </body>
</html>
