<script type="module">
  const BEAVERPHONE_DIALPAD_EVENT_KEY = "beaverphone:dialpad";

  const currentDialpadState = {
    dialedNumber: "",
    isOnCall: false,
    isOnHold: false,
    isSpeakerEnabled: false,
  };

  const beaverPhoneConfig = {
    dialpad: [
      { label: "1" }, { label: "2", subtext: "ABC" }, { label: "3", subtext: "DEF" },
      { label: "4" }, { label: "5", subtext: "JKL" }, { label: "6", subtext: "MNO" },
      { label: "7", subtext: "PQRS" }, { label: "8", subtext: "TUV" }, { label: "9", subtext: "WXYZ" },
      { label: "*" }, { label: "0", subtext: "+" }, { label: "#" },
    ],
    contacts: [
      { name: "Ontario Provincial Police", subtitle: "Internal line", details: "Office 101", extension: "1201", image: "contact/Police.png" },
      { name: "SPCA Niagara", subtitle: "Paws Law", details: "Office 3434", extension: "3434", image: "contact/SPCA.png" },
      { name: "Mom", subtitle: "Mom", details: "Complaints Office", extension: "22", image: null },
      { name: "Services Ontario", subtitle: "Government of Ontario", details: "Desktop *1345", extension: "1345", image: "contact/ontario.svg" },
    ],
    dialpadEventKey: BEAVERPHONE_DIALPAD_EVENT_KEY,
  };

  const dialpadEl = document.getElementById("dialpad");
  const composerInput = document.getElementById("composer-input");
  const statusPill = document.getElementById("status-pill");
  const helperText = document.getElementById("helper-text");
  const callBtn = document.getElementById("call-btn");
  const holdBtn = document.getElementById("hold-btn");
  const speakerBtn = document.getElementById("speaker-btn");
  const eraseBtn = document.getElementById("erase-btn");
  const clearBtn = document.getElementById("clear-btn");
  const extensionList = document.getElementById("extension-list");

  const callBtnLabel = callBtn.querySelector(".btn-label");
  const holdBtnLabel = holdBtn.querySelector(".btn-label");
  const speakerBtnLabel = speakerBtn.querySelector(".btn-label");

  // ðŸ”¹ Dispatcher dâ€™Ã©vÃ©nements enrichi avec "action"
  const dispatchDialpadEvent = (action, number = undefined) => {
    const event = new CustomEvent(beaverPhoneConfig.dialpadEventKey, {
      detail: { action, number },
    });
    window.dispatchEvent(event);
  };

  const updateUI = () => {
    composerInput.value = currentDialpadState.dialedNumber;
    callBtn.dataset.active = currentDialpadState.isOnCall;
    callBtnLabel.textContent = currentDialpadState.isOnCall ? "End" : "Call";
    holdBtn.disabled = !currentDialpadState.isOnCall;
    holdBtn.dataset.active = currentDialpadState.isOnHold;
    holdBtnLabel.textContent = currentDialpadState.isOnHold ? "Resume" : "Hold";
    speakerBtn.dataset.active = currentDialpadState.isSpeakerEnabled;
    speakerBtnLabel.textContent = currentDialpadState.isSpeakerEnabled ? "Mute" : "Speaker";

    if (currentDialpadState.isOnCall) {
      statusPill.dataset.active = "true";
      statusPill.textContent = currentDialpadState.isOnHold ? "On Hold" : "On Call";
      helperText.textContent = currentDialpadState.isOnHold
        ? "Call is on hold. Tap Hold to resume."
        : "You are connected. Use Hold or Speaker as needed.";
    } else if (currentDialpadState.dialedNumber.length > 0) {
      statusPill.dataset.active = "false";
      statusPill.textContent = "Ready";
      helperText.textContent = "Press Call to connect or erase to edit the number.";
    } else {
      statusPill.dataset.active = "false";
      statusPill.textContent = "Ready";
      helperText.textContent = "Tap digits or choose a contact to start dialing.";
    }
  };

  // ðŸ”¹ Ajout des touches numÃ©riques
  const appendDigit = (digit) => {
    currentDialpadState.dialedNumber += digit;
    dispatchDialpadEvent("dtmf", digit);
    updateUI();
  };

  const eraseDigit = () => {
    if (!currentDialpadState.dialedNumber) return;
    currentDialpadState.dialedNumber = currentDialpadState.dialedNumber.slice(0, -1);
    updateUI();
  };

  const resetDialer = () => {
    currentDialpadState.dialedNumber = "";
    currentDialpadState.isOnCall = false;
    currentDialpadState.isOnHold = false;
    updateUI();
  };

  beaverPhoneConfig.dialpad.forEach((item) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "dialpad-key";
    btn.textContent = item.label;
    if (item.subtext) {
      const sub = document.createElement("span");
      sub.textContent = item.subtext;
      btn.appendChild(sub);
    }
    btn.addEventListener("click", () => appendDigit(item.label));
    dialpadEl.appendChild(btn);
  });

  // ðŸ”¹ Bouton Call â†’ envoie "dial" ou "hangup"
  callBtn.addEventListener("click", () => {
    if (!currentDialpadState.isOnCall && currentDialpadState.dialedNumber.length === 0) {
      helperText.textContent = "Enter a number or choose a contact first.";
      return;
    }
    currentDialpadState.isOnCall = !currentDialpadState.isOnCall;

    if (currentDialpadState.isOnCall) {
      dispatchDialpadEvent("dial", currentDialpadState.dialedNumber);
    } else {
      dispatchDialpadEvent("hangup");
    }

    updateUI();
  });

  holdBtn.addEventListener("click", () => {
    if (!currentDialpadState.isOnCall) return;
    currentDialpadState.isOnHold = !currentDialpadState.isOnHold;
    updateUI();
  });

  speakerBtn.addEventListener("click", () => {
    currentDialpadState.isSpeakerEnabled = !currentDialpadState.isSpeakerEnabled;
    updateUI();
  });

  eraseBtn.addEventListener("click", () => {
    if (currentDialpadState.dialedNumber.length === 0) {
      helperText.textContent = "Nothing to erase.";
      return;
    }
    eraseDigit();
  });

  clearBtn.addEventListener("click", () => {
    resetDialer();
    dispatchDialpadEvent("clear");
  });

  composerInput.addEventListener("input", (event) => {
    const { value } = event.target;
    currentDialpadState.dialedNumber = value.replace(/[^0-9*#]/g, "");
    updateUI();
  });

  composerInput.addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      callBtn.click();
    } else if (event.key === "Backspace" && event.metaKey) {
      resetDialer();
      dispatchDialpadEvent("clear");
    }
  });

  // ðŸ”¹ Extensions â†’ appellent direct avec "dial"
  beaverPhoneConfig.contacts.forEach((contact) => {
    const card = document.createElement("article");
    card.className = "extension-card";

    const avatar = document.createElement("div");
    avatar.className = "avatar";
    avatar.setAttribute("aria-hidden", "true");

    if (contact.image) {
      const img = document.createElement("img");
      img.src = contact.image;
      img.alt = `${contact.name} avatar`;
      img.addEventListener("error", () => {
        img.remove();
        avatar.classList.add("avatar--fallback");
        avatar.textContent = contact.name.slice(0, 1).toUpperCase();
      });
      avatar.appendChild(img);
    } else {
      avatar.classList.add("avatar--fallback");
      avatar.textContent = contact.name.slice(0, 1).toUpperCase();
    }

    const info = document.createElement("div");
    const nameEl = document.createElement("h3");
    nameEl.textContent = contact.name;
    const subtitleEl = document.createElement("div");
    subtitleEl.className = "subtitle";
    subtitleEl.textContent = contact.subtitle;
    const detailsEl = document.createElement("div");
    detailsEl.className = "details";
    detailsEl.textContent = contact.details;
    info.appendChild(nameEl);
    info.appendChild(subtitleEl);
    info.appendChild(detailsEl);

    const extension = document.createElement("div");
    extension.className = "extension";
    extension.textContent = `Ext. ${contact.extension}`;

    card.appendChild(avatar);
    card.appendChild(info);
    card.appendChild(extension);

    card.addEventListener("click", () => {
      currentDialpadState.dialedNumber = contact.extension;
      currentDialpadState.isOnCall = true;
      currentDialpadState.isOnHold = false;
      dispatchDialpadEvent("dial", contact.extension);
      updateUI();
    });
    extensionList.appendChild(card);
  });

  if (beaverPhoneConfig.contacts.length === 0) {
    const emptyState = document.createElement("p");
    emptyState.className = "empty-hint";
    emptyState.textContent = "No saved extensions yet.";
    extensionList.appendChild(emptyState);
  }

  updateUI();
</script>
